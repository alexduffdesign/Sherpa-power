{%- comment -%}
  ----------------------------------------------------------------------------------------------------------------------
  BUNDLE KEY FEATURES COMPONENT
  ----------------------------------------------------------------------------------------------------------------------

  This component displays key features for bundle products using mixed reference metafields.
  It handles both key_features_chargers_and_solar and key_features metafield types.
  Uses the same styling and structure as the offer component.

  ********************************************
  Supported variables
  ********************************************

  * title: an optional title for the banner
  * content: the textual content to use
  * icon: the name of an icon that is optionally added along the text
  * icon_width: the width of the icon
  * custom_icon: an image of an optional icon (if any)
  * icon_position: the position of the icon. Accept the values "aligned" or "stacked".
  * text_alignment: alignment of the text
  * background: an optional background that would override existing color
  * text_color: an optional text color that would override existing color
{%- endcomment -%}

{%- capture offer_class -%}offer {% if block.settings.text_alignment == 'center' %}offer--center{% endif %}{%- endcapture -%}
<div {% render 'surface', class: offer_class, background: block.settings.background, text_color: block.settings.text_color, background_fallback: 'bg-secondary' %} {{ block.shopify_attributes }}>
  {%- capture icon_with_title -%}
    {%- if block.settings.custom_icon != blank -%}
      {%- capture sizes -%}{{ block.settings.icon_width }}px{%- endcapture -%}
      {%- capture widths -%}{{ block.settings.icon_width }}, {{ block.settings.icon_width | times: 2 | at_most: block.settings.custom_icon.width }}{%- endcapture -%}
      {%- capture style -%}max-width: {{ block.settings.icon_width }}px{%- endcapture -%}
      {{- block.settings.custom_icon | image_url: width: block.settings.custom_icon.width | image_tag: loading: 'lazy', style: style, sizes: sizes, widths: widths -}}
    {%- elsif block.settings.icon != 'none' -%}
      {%- render 'icon' with block.settings.icon, width: block.settings.icon_width, height: block.settings.icon_width -%}
    {%- endif -%}

    {%- if block.settings.title != blank -%}
      <h3 class="bold text-lg">{{ block.settings.title | escape }}</h3>
    {%- endif -%}
  {%- endcapture -%}
  
  {%- if icon_with_title != blank -%}
    {%- if block.settings.icon_position == 'aligned' -%}
      <div class="text-with-icon">
        {{- icon_with_title -}}
      </div>
    {%- else -%}
      {{- icon_with_title -}}
    {%- endif -%}
  {%- endif -%}

  {%- if block.settings.content != blank -%}
    <div class="prose text-sm">
      {{- block.settings.content -}}
    </div>
  {%- endif -%}

  <style>
    .product-feature {
      margin-bottom: 1.4rem;
    }
    .bundle-product-features {
      margin-bottom: 2rem;
    }
    .bundle-product-title {
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(0,0,0,0.1);
      font-weight: bold;
      color: var(--heading-color, #333);
    }
  </style>

  {% comment %}
    Bundle key features for mixed reference metafields
  {% endcomment %}

  {%- assign bundle_key_features = product.metafields.custom.bundle_key_features.value -%}

  {% if bundle_key_features != blank %}
    <div class="bundle-key-features">
      {% for feature_reference in bundle_key_features %}
        
        {% comment %} Check if this is a key_features_chargers_and_solar reference by checking for specific fields {% endcomment %}
        {% if feature_reference.product_name != blank and feature_reference.output_power != blank %}
          <div class="bundle-product-features">
            
            <!-- Debug: Show charger/solar reference structure -->
            <div style="background: #f0f0f0; padding: 0.5rem; margin: 0.5rem 0; font-size: 12px;">
              <strong>Debug charger/solar reference:</strong><br>
              {{ feature_reference | json }}
            </div>
            
            {%- if feature_reference.product_name != blank -%}
              <h4 class="bundle-product-title">{{ feature_reference.product_name }}</h4>
            {%- endif -%}

            {%- if feature_reference.output_power != blank -%}
              <div class="product-feature">
                <strong>‚ö°Ô∏è Output Power</strong><br> {{ feature_reference.output_power }}
              </div>
            {%- endif -%}

            {%- if feature_reference.output_voltage != blank -%}
              <div class="product-feature">
                <strong>‚ö°Ô∏è Output Voltage</strong><br> {{ feature_reference.output_voltage }}
              </div>
            {%- endif -%}

            {%- if feature_reference.output_current != blank -%}
              <div class="product-feature">
                <strong>‚ö°Ô∏è Output Current</strong><br> {{ feature_reference.output_current }}
              </div>
            {%- endif -%}

            {%- if feature_reference.input_voltage != blank -%}
              <div class="product-feature">
                <strong>‚ö°Ô∏è Input Voltage</strong><br> {{ feature_reference.input_voltage }}
              </div>
            {%- endif -%}

            {%- if feature_reference.warranty != blank -%}
              <div class="product-feature">
                <strong>üõ°Ô∏è Warranty</strong><br> {{ feature_reference.warranty }}
              </div>
            {%- endif -%}

            {%- if feature_reference.weight != blank -%}
              <div class="product-feature">
                <strong>‚öñ Weight</strong><br> {{ feature_reference.weight }}
              </div>
            {%- endif -%}
          </div>

        {% elsif feature_reference.product != blank %}
          <div class="bundle-product-features">
            {%- if feature_reference.product != blank -%}
              <h4 class="bundle-product-title">{{ feature_reference.product }}</h4>
            {%- endif -%}

            {%- if feature_reference.battery != blank -%}
              <div class="product-feature">
                <strong>üîã Battery</strong><br> {{ feature_reference.battery }}
              </div>
            {%- endif -%}

            {%- if feature_reference.output_ac != blank -%}
              <div class="product-feature">
                <strong>‚ö° Output (AC)</strong><br> {{ feature_reference.output_ac }}
              </div>
            {%- endif -%}

            {%- if feature_reference.output_dc != blank -%}
              <div class="product-feature">
                <strong>üí° Output (DC)</strong><br> {{ feature_reference.output_dc }}
              </div>
            {%- endif -%}

            {%- if feature_reference.input_ac != blank -%}
              <div class="product-feature">
                <strong>üîå Input (AC)</strong><br> {{ feature_reference.input_ac }}
              </div>
            {%- endif -%}

            {%- if feature_reference.input_solar_dc != blank -%}
              <div class="product-feature">
                <strong>Input (üîÜ Solar/ ‚ö°üîå DC )</strong><br> {{ feature_reference.input_solar_dc }}
              </div>
            {%- endif -%}

            {%- if feature_reference.charge_time != blank -%}
              <div class="product-feature">
                <strong>‚è≥ Charge Time</strong><br> {{ feature_reference.charge_time }}
              </div>
            {%- endif -%}

            {%- if feature_reference.warranty != blank -%}
              <div class="product-feature">
                <strong>üõ°Ô∏è Warranty</strong><br> {{ feature_reference.warranty }}
              </div>
            {%- endif -%}

            {%- if feature_reference.weight != blank -%}
              <div class="product-feature">
                <strong>‚öñ Weight</strong><br> {{ feature_reference.weight }}
              </div>
            {%- endif -%}

            {%- if feature_reference.app_compatible != blank -%}
              <div class="product-feature">
                <strong>üì± App Compatible</strong><br> {{ feature_reference.app_compatible }}
              </div>
            {%- endif -%}

            {%- if feature_reference.expandable_capacity != blank -%}
              <div class="product-feature">
                <strong>üîó Expandable Capacity</strong><br> {{ feature_reference.expandable_capacity }}
              </div>
            {%- endif -%}
          </div>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}
</div>