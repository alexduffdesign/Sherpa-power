{%- unless section.settings.full_width -%}
  {%- render 'section-spacing-collapsing' -%}
{%- endunless -%}

<style>
  #shopify-section-{{ section.id }} {
    {%- if section.settings.full_width -%}
      --section-outer-spacing-block: 0;
    {%- endif -%}

    --content-over-media-overlay: {{ section.settings.overlay_color.rgb }} / {{ section.settings.overlay_opacity | divided_by: 100.0 }};

    {%- if section.settings.allow_transparent_header -%}
      margin-block-start: calc(-1 * var(--header-height) * var(--section-is-first));
    {%- endif -%}
  }

  /* Ensure overlay scrim and text remain above decorative layers */
  #shopify-section-{{ section.id }} .content-over-media:before { z-index: 2; }
  #shopify-section-{{ section.id }} .content-over-media > :not(img, video, iframe, svg, video-media, rive-media) { z-index: 3; }

  /* Rive layer positioning */
  #shopify-section-{{ section.id }} .rive-layer {
    position: absolute;
    inset: 0;
    pointer-events: none;
    overflow: hidden;
  }

  #shopify-section-{{ section.id }} .rive-layer rive-media {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    display: block;
  }

  @media (prefers-reduced-motion: reduce) {
    #shopify-section-{{ section.id }} .rive-layer rive-media[playing] {
      /* Pause when reduced motion requested */
      animation: none;
    }
  }
</style>

<div {% render 'section-properties' %} {% if section.settings.allow_transparent_header %}allow-transparent-header{% endif %}>
  {%- capture class -%}content-over-media content-over-media--{{ section.settings.image_size }} {% if section.settings.full_width %}full-bleed{% else %}shadow-block rounded-lg{% endif %}{%- endcapture -%}

  <image-banner reveal-on-scroll="true" {% if section.settings.enable_parallax %}parallax="0.3"{% endif %} {% render 'surface', class: class, text_color: section.settings.text_color %}>
    {%- if section.settings.image != blank -%}
      {%- capture image_class -%}{% if section.settings.mobile_image != blank %}hidden sm:block{% endif %}{%- endcapture -%}
      {%- capture sizes -%}{% if section.settings.full_width %}100vw{% else %}(max-width: 740px) calc(100vw - 40px), (max-width: 999px) calc(100vw - 64px), min({{ settings.page_width }}px, 100vw - 96px){% endif %}{%- endcapture -%}

      {{- section.settings.image | image_url: width: section.settings.image.width | image_tag: loading: 'lazy', sizes: sizes, widths: '200,300,400,500,600,700,800,900,1000,1200,1400,1600,1800,2000,2200,2400,2600,2800,3000,3200', class: image_class -}}

      {%- if section.settings.mobile_image != blank -%}
        {{- section.settings.mobile_image | image_url: width: section.settings.mobile_image.width | image_tag: loading: 'lazy', sizes: sizes, widths: '200,300,400,500,600,700,800,900,1000,1200,1400,1600', class: 'sm:hidden' -}}
      {%- endif -%}
    {%- else -%}
      {{ 'lifestyle-1' | placeholder_svg_tag: 'placeholder' | replace: '<svg', '<svg preserveAspectRatio="xMinYMin slice"' }}
    {%- endif -%}

    {%- if section.settings.overlay_image != blank or section.settings.overlay_mobile_image != blank -%}
      {%- capture overlay_sizes -%}{% if section.settings.full_width %}100vw{% else %}(max-width: 740px) calc(100vw - 40px), (max-width: 999px) calc(100vw - 64px), min({{ settings.page_width }}px, 100vw - 96px){% endif %}{%- endcapture -%}

      {%- if section.settings.overlay_image != blank -%}
        {{- section.settings.overlay_image | image_url: width: section.settings.overlay_image.width | image_tag: loading: 'lazy', sizes: overlay_sizes, widths: '200,300,400,500,600,700,800,900,1000,1200,1400,1600,1800,2000,2200,2400,2600,2800,3000,3200', class: 'hidden sm:block pointer-events-none', style: 'position:absolute;top:0;left:0;right:0;bottom:0;width:100%;height:100%;z-index:1;' -}}
      {%- endif -%}

      {%- if section.settings.overlay_mobile_image != blank -%}
        {{- section.settings.overlay_mobile_image | image_url: width: section.settings.overlay_mobile_image.width | image_tag: loading: 'lazy', sizes: overlay_sizes, widths: '200,300,400,500,600,700,800,900,1000,1200,1400,1600', class: 'sm:hidden pointer-events-none', style: 'position:absolute;top:0;left:0;right:0;bottom:0;width:100%;height:100%;z-index:1;' -}}
      {%- endif -%}
    {%- endif -%}

    {%- comment -%}
      Rive animation blocks (decorative layer). Multiple blocks allowed.
    {%- endcomment -%}
    {%- for block in section.blocks -%}
      {%- if block.type == 'rive_animation' -%}
        <div class="rive-layer" style="z-index: {% if block.settings.layer == 'above_overlay' %}3{% else %}1{% endif %};" {{ block.shopify_attributes }}>
          <rive-media
            {% if block.settings.play_when_in_view %}play-when-in-view{% endif %}
            {% if block.settings.autoplay %}autoplay{% endif %}
            src="{{ block.settings.rive_src | escape }}"
            {% if block.settings.artboard != blank %}artboard="{{ block.settings.artboard | escape }}"{% endif %}
            {% if block.settings.state_machines != blank %}state-machines="{{ block.settings.state_machines | escape }}"{% endif %}
          ></rive-media>
        </div>
      {%- endif -%}
    {%- endfor -%}

    {%- if section.blocks.size > 0 -%}
      <div class="{{ section.settings.mobile_text_position }} {{ section.settings.desktop_text_position }}">
        <div class="prose">
          {%- for block in section.blocks -%}
            {%- case block.type -%}
              {%- when 'subheading' -%}
                {%- if block.settings.text != blank -%}
                  <p class="bold" {{ block.shopify_attributes }}>{{ block.settings.text | escape }}</p>
                {%- endif -%}

              {%- when 'heading' -%}
              <div img-w-text_wrap >
              {%- if block.settings.range_text != blank -%}
                  <p  class="{{ block.settings.heading_tag }}" {% if settings.heading_apparition != 'none' %}reveal-on-scroll="false"{% endif %} {{ block.shopify_attributes }}>
                    {%- render 'styled-text', gradient: block.settings.heading_gradient, content: block.settings.range_text, apparition_effect: true -%}
                  </p>
                {%- endif -%}

                {%- if block.settings.text != blank -%}
                  <h1 no-margin class="{{ block.settings.heading_tag }}" {% if settings.heading_apparition != 'none' %}reveal-on-scroll="false"{% endif %} {{ block.shopify_attributes }}>
                    {%- render 'styled-text', content: block.settings.text, apparition_effect: true -%}
                  </h1>
                {%- endif -%}
              </div>

              {%- when 'richtext' -%}
                {%- if block.settings.content != blank -%}
                  <div {{ block.shopify_attributes }}>
                    {{- block.settings.content -}}
                  </div>
                {%- endif -%}

              {%- when 'liquid' -%}
                {%- if block.settings.liquid != blank -%}
                  <div {{ block.shopify_attributes }}>
                    {{- block.settings.liquid -}}
                  </div>
                {%- endif -%}

              {%- when 'button' -%}
                {%- if block.settings.text != blank -%}
                  {% render 'button', content: block.settings.text, href: block.settings.url, size: block.settings.size, style: block.settings.style, background: block.settings.background, text_color: block.settings.text_color, block: block %}
                {%- endif -%}
            {%- endcase -%}
          {%- endfor -%}
        </div>
      </div>
    {%- endif -%}
  </image-banner>
</div>

{% schema %}
{
  "name": "Image with text (Rive)",
  "class": "shopify-section--image-with-text-overlay",
  "tag": "section",
  "disabled_on": {
    "templates": ["password"],
    "groups": ["header", "custom.overlay"]
  },
  "max_blocks": 8,
  "settings": [
    { "type": "checkbox", "id": "full_width", "label": "Full width", "default": true },
    { "type": "checkbox", "id": "allow_transparent_header", "label": "Allow transparent header", "info": "This setting only applies when this section is the first one.", "default": false },
    { "type": "checkbox", "id": "enable_parallax", "label": "Enable parallax effect", "info": "Parallax crops images.", "default": false },
    { "type": "select", "id": "image_size", "label": "Image size", "options": [
      { "value": "auto", "label": "Original image ratio" },
      { "value": "sm", "label": "Small" },
      { "value": "md", "label": "Medium" },
      { "value": "lg", "label": "Large" },
      { "value": "fill", "label": "Fill screen" }
    ], "default": "auto",
    "info": "Choose \"Original image ratio\" to avoid image cropping."
    },
    { "type": "image_picker", "id": "image", "label": "Image", "info": "3200 x 1600px .jpg recommended" },
    { "type": "image_picker", "id": "mobile_image", "label": "Mobile image", "info": "1300 x 1500px .jpg recommended. Default to desktop image." },
    { "type": "header", "content": "Overlay images" },
    { "type": "image_picker", "id": "overlay_image", "label": "Overlay image" },
    { "type": "image_picker", "id": "overlay_mobile_image", "label": "Overlay mobile image" },
    { "type": "header", "content": "Colors" },
    { "type": "color", "id": "text_color", "label": "Text", "default": "#ffffff" },
    { "type": "color", "id": "overlay_color", "label": "Overlay", "default": "#000000" },
    { "type": "range", "id": "overlay_opacity", "label": "Overlay opacity", "min": 0, "max": 100, "step": 1, "unit": "%", "default": 30 }
  ],
  "blocks": [
    {
      "type": "subheading",
      "name": "Subheading",
      "settings": [ { "type": "text", "id": "text", "label": "Text", "default": "Subheading" } ]
    },
    {
      "type": "heading",
      "name": "Heading",
      "settings": [
        { "type": "text", "id": "range_text", "label": "Range Text", "default": "Heading" },
        { "type": "text", "id": "text", "label": "Text", "default": "Heading" },
        { "type": "select", "id": "heading_tag", "label": "Style", "options": [
          { "value": "h0", "label": "XX-Large" },
          { "value": "h1", "label": "X-Large" },
          { "value": "h2", "label": "Large" },
          { "value": "h3", "label": "Medium" },
          { "value": "h4", "label": "Small" },
          { "value": "h5", "label": "X-Small" },
          { "value": "h6", "label": "XX-Small" }
        ], "default": "h1" },
        { "type": "color_background", "id": "heading_gradient", "label": "Impact text gradient" }
      ]
    },
    { "name": "Paragraph", "type": "richtext", "settings": [ { "type": "richtext", "id": "content", "label": "Content", "default": "<p>Use this text to share information about your brand with your customers.</p>" } ] },
    { "name": "Liquid", "type": "liquid", "settings": [ { "type": "liquid", "id": "liquid", "label": "Liquid", "default": "<p>Use this text to output some custom Liquid code.</p>" } ] },
    { "name": "Button", "type": "button", "settings": [
      { "type": "select", "id": "style", "label": "Style", "options": [ { "value": "outline", "label": "Outline" }, { "value": "fill", "label": "Fill" } ], "default": "fill" },
      { "type": "select", "id": "size", "label": "Size", "options": [ { "value": "sm", "label": "Small" }, { "value": "base", "label": "Medium" }, { "value": "lg", "label": "Large" }, { "value": "xl", "label": "X-Large" } ], "default": "lg" },
      { "type": "text", "id": "text", "label": "Text", "default": "Button text" },
      { "type": "url", "id": "url", "label": "Link" },
      { "type": "color", "id": "background", "label": "Background" },
      { "type": "color", "id": "text_color", "label": "Text" }
    ] },
    {
      "name": "Rive animation",
      "type": "rive_animation",
      "settings": [
        { "type": "text", "id": "rive_src", "label": "Rive file URL (.riv)", "info": "Provide a public URL to your .riv file (Shopify Files or CDN)." },
        { "type": "text", "id": "state_machines", "label": "State machines (comma-separated)" },
        { "type": "text", "id": "artboard", "label": "Artboard name" },
        { "type": "checkbox", "id": "autoplay", "label": "Autoplay", "default": true },
        { "type": "checkbox", "id": "play_when_in_view", "label": "Play when in view", "default": true },
        { "type": "select", "id": "layer", "label": "Layer position", "options": [
          { "value": "below_overlay", "label": "Below overlay (behind scrim)" },
          { "value": "above_overlay", "label": "Above overlay (behind text)" }
        ], "default": "below_overlay" }
      ]
    }
  ],
  "presets": [
    {
      "name": "Image with text (Rive)",
      "blocks": [
        { "type": "subheading", "settings": { "text": "Subheading" } },
        { "type": "heading", "settings": { "text": "Image with text overlay", "heading_tag": "h1" } },
        { "type": "richtext" },
        { "type": "rive_animation", "settings": { "rive_src": "https://cdn.rive.app/animations/vehicles.riv", "state_machines": "bumpy", "autoplay": true } }
      ]
    }
  ]
}
{% endschema %}


