{"version":3,"file":"chatbot-main.kbx_CF1e.js","sources":["../frontend/utils/user-id-generator.js","../frontend/mainChatbot/chatbot-main.js"],"sourcesContent":["/**\n * Generates a unique user ID with the specified prefix.\n * @param {string} prefix - The prefix indicating the chatbot type ('mainChatbot' or 'sectionChatbot').\n * @returns {string} - The generated unique user ID.\n */\nexport function generateUserId(prefix) {\n  const uniquePart =\n    Date.now().toString(36) + Math.random().toString(36).substr(2, 9);\n  return `${prefix}-${uniquePart}`;\n}\n","// /frontend/mainChatbot/chatbot-main.js\n\nimport ChatbotCore from \"../baseChatbot/base-chatbot.js\";\nimport MainChatbotUI from \"./chatbot-main-ui.js\";\nimport { generateUserId } from \"../utils/user-id-generator.js\";\n\n/**\n * MainChatbot Class\n * Handles main chatbot functionality including history management and drawer integration\n */\nclass MainChatbot {\n  /**\n   * @param {HTMLElement} container - The container element for the chatbot\n   */\n  constructor(container) {\n    this.container = container;\n    this.historyKey = \"mainChatbotHistory\";\n    this.launchKey = \"chatHasLaunched\";\n    this.isLaunched = this.hasLaunched();\n\n    // Initialize core and UI\n    this.initialize();\n  }\n\n  /**\n   * Initialize the chatbot components\n   * @private\n   */\n  initialize() {\n    // Set up user ID\n    let userId = localStorage.getItem(\"mainChatbotUserId\");\n    if (!userId) {\n      userId = generateUserId(\"mainChatbot\");\n      localStorage.setItem(\"mainChatbotUserId\", userId);\n    }\n\n    // Initialize core\n    this.core = new ChatbotCore({\n      type: \"main\",\n      endpoint:\n        \"https://chatbottings--development.gadget.app/voiceflowAPI/voiceflow-streaming\",\n      userID: userId,\n    });\n\n    // Initialize UI\n    this.ui = new MainChatbotUI({\n      container: this.container,\n      eventBus: this.core.eventBus,\n      type: \"main\",\n    });\n\n    this.setupEventListeners();\n    this.loadHistory();\n  }\n\n  /**\n   * Set up event listeners\n   * @private\n   */\n  setupEventListeners() {\n    // Handle user messages\n    this.core.eventBus.on(\"userMessage\", (message) => {\n      this.saveToHistory(\"user\", message);\n    });\n\n    this.core.eventBus.on(\n      \"assistantMessageNonStreamed\",\n      ({ content, metadata }) => {\n        this.saveToHistory(\"assistant\", content, metadata);\n      }\n    );\n\n    // Handle responses with potential text and animation\n    this.core.eventBus.on(\"messageReceived\", ({ content, metadata }) => {\n      this.ui.addMessage(\"assistant\", content, metadata, false);\n    });\n\n    // Handle the final part of a streamed message\n    this.core.eventBus.on(\n      \"assistantMessageFinalized\",\n      ({ content, metadata }) => {\n        // Changed finalContent to content\n        console.log(\n          \"assistantMessageFinalized received with content:\",\n          content\n        );\n        this.saveToHistory(\"assistant\", content, metadata); // Changed finalContent to content\n      }\n    );\n\n    // Handle errors\n    this.core.eventBus.on(\"error\", ({ message }) => {\n      this.ui.displayError(message);\n    });\n\n    // Handle choice presentation (saves them to history)\n    this.core.eventBus.on(\"choicePresented\", ({ buttons }) => {\n      this.saveToHistory(\"assistant\", \"Choice presented\", {\n        type: \"choice\",\n        buttons: buttons,\n      });\n    });\n\n    this.core.eventBus.on(\"carouselPresented\", ({ items }) => {\n      this.saveToHistory(\"assistant\", \"Carousel presented\", {\n        type: \"carousel\",\n        carouselItems: items,\n      });\n    });\n\n    // Handle button clicks (both carousel and choice buttons)\n    this.core.eventBus.on(\"buttonClicked\", (payload) => {\n      const userMessage = payload.label || \"Button clicked\";\n      this.saveToHistory(\"user\", userMessage);\n    });\n\n    // Handle main menu\n    this.core.eventBus.on(\"mainMenu\", () => {\n      const userMessage = \"Main menu\";\n      this.saveToHistory(\"user\", userMessage);\n      // Add message without animation and faster speed\n      this.ui.addMessage(\"user\", userMessage, null, false); // fromHistory=false\n      this.core.sendAction({\n        action: {\n          type: \"event\",\n          payload: {\n            event: {\n              name: \"main_menu\",\n            },\n          },\n        },\n      });\n    });\n\n    // Handle product redirects\n    this.core.eventBus.on(\"productRedirect\", ({ productHandle }) => {\n      this.handleProductRedirect(productHandle);\n    });\n\n    // Handle clearing history\n    this.core.eventBus.on(\"clearHistory\", () => {\n      this.clearHistory();\n    });\n\n    // Handle minimizing chatbot\n    this.core.eventBus.on(\"minimize\", () => {\n      // Implement minimize functionality as needed\n      console.log(\"Minimize chatbot\");\n      // For example, hide the chatbot container or trigger a CSS class\n      this.container.classList.toggle(\"minimized\");\n    });\n  }\n\n  /**\n   * Check if chatbot has been launched before\n   * @private\n   * @returns {boolean}\n   */\n  hasLaunched() {\n    return localStorage.getItem(this.launchKey) === \"true\";\n  }\n\n  /**\n   * Set launched state\n   * @private\n   */\n  setLaunched() {\n    localStorage.setItem(this.launchKey, \"true\");\n    this.isLaunched = true;\n  }\n\n  /**\n   * Launch the chatbot\n   * @public\n   */\n  async launch() {\n    if (this.isLaunched) {\n      console.log(\"Chat already launched, skipping launch request\");\n      return;\n    }\n\n    try {\n      await this.core.sendLaunch();\n      this.setLaunched();\n    } catch (error) {\n      console.error(\"Error launching chatbot:\", error);\n      this.ui.displayError(\n        \"Failed to launch the chatbot. Please try again later.\"\n      );\n    }\n  }\n\n  /**\n   * Save message to history\n   * @private\n   * @param {string} sender - Message sender\n   * @param {string} message - Message content\n   * @param {Object} metadata - Optional metadata\n   */\n  saveToHistory(sender, message, metadata = null) {\n    console.log(\"saveToHistory called with:\", { sender, message, metadata }); // Add this line\n    const history = JSON.parse(localStorage.getItem(this.historyKey)) || [];\n\n    const historyEntry = {\n      sender,\n      message,\n      timestamp: Date.now(),\n      isInteractive: false,\n    };\n\n    if (sender === \"assistant\" && metadata) {\n      if (metadata.type === \"choice\") {\n        historyEntry.isInteractive = true;\n        historyEntry.traceType = \"choice\";\n        historyEntry.traceData = { buttons: metadata.buttons };\n      } else if (metadata.type === \"carousel\") {\n        historyEntry.isInteractive = true;\n        historyEntry.traceType = \"carousel\";\n        historyEntry.traceData = { cards: metadata.carouselItems };\n      }\n    }\n\n    history.push(historyEntry);\n    localStorage.setItem(this.historyKey, JSON.stringify(history));\n  }\n\n  /**\n   * Load conversation history\n   * @private\n   */\n  loadHistory() {\n    const history = JSON.parse(localStorage.getItem(this.historyKey)) || [];\n    console.log(\"Loading history:\", history); // Log the entire history array\n\n    history.forEach((entry, index) => {\n      console.log(\"Processing history entry:\", entry);\n\n      if (entry.isInteractive) {\n        console.log(\"Entry is interactive:\", entry);\n\n        if (index === history.length - 1) {\n          console.log(\"Restoring interactive element from history\");\n\n          this.restoreInteractiveElement(entry);\n        }\n        return;\n      }\n\n      if (entry.message) {\n        console.log(\"Adding message from history:\", entry);\n\n        // Pass fromHistory=true to disable animation\n        this.ui.addMessage(entry.sender, entry.message, null, true);\n      }\n    });\n  }\n\n  /**\n   * Handle redirecting to product pages\n   * @private\n   * @param {string} productHandle - The product handle to redirect to\n   */\n  handleProductRedirect(productHandle) {\n    if (!productHandle) {\n      console.error(\"Cannot redirect: Product handle is undefined or empty\");\n      return;\n    }\n\n    const baseUrl = \"https://www.sherpapower.co.uk/products/\";\n    const productUrl = `${baseUrl}${encodeURIComponent(productHandle)}`;\n    console.log(`Redirecting to product page: ${productUrl}`);\n    window.location.href = productUrl;\n  }\n\n  /**\n   * Restore interactive elements from history\n   * @private\n   * @param {Object} historyEntry - The history entry to restore\n   */\n  restoreInteractiveElement(historyEntry) {\n    if (historyEntry.traceType === \"choice\") {\n      this.ui.addButtons(historyEntry.traceData.buttons, true);\n    } else if (historyEntry.traceType === \"carousel\") {\n      this.ui.addCarousel(historyEntry.traceData.cards, true);\n    }\n  }\n\n  /**\n   * Clear chat history\n   * @public\n   */\n  clearHistory() {\n    localStorage.removeItem(this.historyKey);\n    localStorage.removeItem(this.launchKey);\n    this.isLaunched = false;\n    this.ui.clearChat();\n  }\n\n  /**\n   * Clean up resources\n   * @public\n   */\n  destroy() {\n    this.core.destroy();\n    this.ui.destroy();\n  }\n}\n\nexport default MainChatbot;\nwindow.MainChatbot = MainChatbot;\n"],"names":["generateUserId","prefix","uniquePart","MainChatbot","container","userId","ChatbotCore","MainChatbotUI","message","content","metadata","buttons","items","payload","userMessage","productHandle","error","sender","history","historyEntry","entry","index","productUrl"],"mappings":"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"}