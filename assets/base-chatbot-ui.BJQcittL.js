import"./vendor.DqvJXvYX.js";import{p as i}from"./markdown-util.gcjemE0m.js";class h{constructor(t){if(!t.container)throw new Error("ChatbotUI requires a container element");if(!t.eventBus)throw new Error("ChatbotUI requires an event bus");this.container=t.container,this.eventBus=t.eventBus,this.type=t.type,this.currentAssistantMessage=null,this.accumulatedContent="",this.setupUIElements(),this.setupEventListeners()}setupUIElements(){var a;const t=this.container.querySelectorAll(".message-container");this.messageContainer=t[0],console.log("Message container found:",!!this.messageContainer);const e=this.container.querySelectorAll(".chat-form");this.form=e[0],console.log("Chat form found:",!!this.form);const s=this.container.querySelectorAll(".chatbot-input");this.input=s[0],console.log("Chat input found:",!!this.input);const n=this.container.querySelectorAll(".chat-typing");if(this.typingIndicator=n[0],console.log("Typing indicator found:",!!this.typingIndicator),this.typingText=(a=this.typingIndicator)==null?void 0:a.querySelector(".typing-text"),console.log("Typing text found:",!!this.typingText),console.log("Container HTML:",this.container.innerHTML),!this.messageContainer||!this.form||!this.input){const o=[];throw this.messageContainer||o.push("message-container"),this.form||o.push("chat-form"),this.input||o.push("chatbot-input"),new Error(`Required UI elements not found: ${o.join(", ")}`)}}setupEventListeners(){this.form.addEventListener("submit",t=>{t.preventDefault();const e=this.input.value.trim();e&&(this.eventBus.emit("userMessage",e),this.input.value="")}),this.eventBus.on("messageReceived",({content:t,metadata:e})=>{console.log("UI received messageReceived event:",t,e),this.handleAssistantMessage(t,e)}),this.eventBus.on("partialMessage",t=>{this.handlePartialMessage(t)}),this.eventBus.on("finalMessage",t=>{this.handleFinalMessage(t)}),this.eventBus.on("typing",({isTyping:t})=>{t?this.showTypingIndicator():this.hideTypingIndicator()}),this.eventBus.on("error",({message:t})=>{this.displayError(t)}),this.eventBus.on("choicePresented",({buttons:t})=>{this.addButtons(t)}),this.eventBus.on("carouselPresented",({items:t})=>{this.addCarousel(t)}),this.eventBus.on("end",()=>{this.currentAssistantMessage=null,this.accumulatedContent=""})}handleAssistantMessage(t,e){const s=i(t),n=this.createMessage("assistant",s,e);this.messageContainer.appendChild(n),this.scrollToBottom()}handlePartialMessage(t){this.accumulatedContent+=t;const e=/([.!?;]\s)|(\n)/,s=this.accumulatedContent.match(e);if(s){const n=s.index+s[0].length,a=this.accumulatedContent.slice(0,n).trim(),o=this.accumulatedContent.slice(n).trim();this.currentAssistantMessage?this.currentAssistantMessage.appendContent(i(a)):(this.currentAssistantMessage=this.createMessage("assistant",i(a),null),this.messageContainer.appendChild(this.currentAssistantMessage)),this.accumulatedContent=o,this.scrollToBottom()}else this.currentAssistantMessage?this.currentAssistantMessage.appendContent(i(t)):(this.currentAssistantMessage=this.createMessage("assistant",i(t),null),this.messageContainer.appendChild(this.currentAssistantMessage)),this.scrollToBottom()}handleFinalMessage(t){if(this.currentAssistantMessage)this.currentAssistantMessage.appendContent(i(t)),this.currentAssistantMessage=null,this.accumulatedContent="",this.scrollToBottom();else{const e=i(t),s=this.createMessage("assistant",e,null);this.messageContainer.appendChild(s),this.scrollToBottom()}}createMessage(t,e,s=null){const n=document.createElement("message-component");return n.eventBus=this.eventBus,n.setAttribute("sender",t),n.setAttribute("content",e),s&&n.setAttribute("metadata",JSON.stringify(s)),n}addMessage(t,e,s=null){if(console.log(`addMessage called with sender=${t}, content=${e}, metadata=`,s),t==="assistant")this.handleAssistantMessage(e,s);else{const n=this.createMessage(t,e,s);this.messageContainer.appendChild(n),this.scrollToBottom()}}addButtons(t){if(!Array.isArray(t)){console.error("Invalid buttons data:",t);return}const e=document.createElement("div");e.className="button-group",t.forEach(s=>{const n=document.createElement("button-component");n.eventBus=this.eventBus,n.setAttribute("label",s.name),n.setAttribute("payload",JSON.stringify(s.request)),e.appendChild(n)}),this.messageContainer.appendChild(e),this.scrollToBottom()}addCarousel(t){if(!Array.isArray(t)){console.error("Invalid carousel items:",t);return}const e=document.createElement("carousel-component");e.eventBus=this.eventBus,e.setAttribute("data-carousel",JSON.stringify({cards:t})),this.messageContainer.appendChild(e),this.scrollToBottom()}showTypingIndicator(){this.typingIndicator&&(this.typingIndicator.style.display="flex",this.scrollToBottom())}hideTypingIndicator(){this.typingIndicator&&(this.typingIndicator.style.display="none")}displayError(t){const e=document.createElement("div");e.classList.add("error-message"),e.textContent=t,this.messageContainer.appendChild(e),this.scrollToBottom()}removeInteractiveElements(){this.messageContainer.querySelectorAll("button-component, carousel-component, .button-group").forEach(e=>e.remove())}scrollToBottom(){this.messageContainer.scrollTop=this.messageContainer.scrollHeight}destroy(){this.eventBus.removeAllListeners()}}export{h as C};
//# sourceMappingURL=base-chatbot-ui.BJQcittL.js.map
