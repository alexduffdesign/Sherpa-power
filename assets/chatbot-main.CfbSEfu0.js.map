{"version":3,"file":"chatbot-main.CfbSEfu0.js","sources":["../frontend/entrypoints/chatbot-main.js"],"sourcesContent":["// chatbot-main.js\n\nimport { ChatbotBase } from \"./chatbot-base\";\nimport { HistoryHandler } from \"./chatbot-history\";\n\nexport class MainChatbot extends ChatbotBase {\n  constructor(element, config) {\n    console.log(\"MainChatbot constructor called with config:\", config);\n    super(config);\n\n    this.element = element;\n    this.history = new HistoryHandler();\n\n    this.initializeElements();\n    this.setupEventListeners();\n\n    // Launch the chatbot after initialization\n    this.launchChatbot();\n  }\n\n  async launchChatbot() {\n    try {\n      await this.api.launch();\n    } catch (error) {\n      console.error(\"Error launching chatbot:\", error);\n      this.ui.addMessage(\n        \"assistant\",\n        \"Sorry, there was an error initializing the chatbot. Please refresh the page.\"\n      );\n    }\n  }\n\n  initializeElements() {\n    this.messageContainer = this.element.querySelector(\".message-container\");\n    this.typingIndicator = this.element.querySelector(\".typing-indicator\");\n    this.drawerBody = this.element.querySelector(\".drawer-body\");\n    this.chatInput = this.element.querySelector(\".chat-input\");\n    this.sendButton = this.element.querySelector(\".send-button\");\n    this.backToStartButton = this.element.querySelector(\n      \".back-to-start-button\"\n    );\n\n    this.setDOMElements(\n      this.messageContainer,\n      this.typingIndicator,\n      this.drawerBody\n    );\n  }\n\n  setupEventListeners() {\n    if (this.chatInput && this.sendButton) {\n      // Find the form element\n      const form = this.chatInput.closest(\"form\");\n      if (form) {\n        // Prevent form submission and handle input\n        form.addEventListener(\"submit\", async (e) => {\n          e.preventDefault();\n          e.stopPropagation();\n          await this.handleUserInput();\n          return false;\n        });\n      }\n\n      // Handle Enter key press\n      this.chatInput.addEventListener(\"keypress\", async (event) => {\n        if (event.key === \"Enter\" && !event.shiftKey) {\n          event.preventDefault();\n          event.stopPropagation();\n          await this.handleUserInput();\n        }\n      });\n\n      // Handle send button click\n      this.sendButton.addEventListener(\"click\", async (e) => {\n        e.preventDefault();\n        e.stopPropagation();\n        await this.handleUserInput();\n      });\n    }\n\n    if (this.backToStartButton) {\n      this.backToStartButton.addEventListener(\"click\", () => {\n        this.jumpToMainMenu();\n      });\n    }\n\n    if (this.messageContainer) {\n      this.messageContainer.addEventListener(\"click\", async (event) => {\n        const button = event.target.closest(\".chat-button\");\n        if (button) {\n          const buttonData = JSON.parse(button.dataset.buttonData);\n          await this.handleButtonClick(buttonData);\n        }\n      });\n    }\n  }\n\n  async handleUserInput() {\n    const message = this.chatInput.value.trim();\n    if (message) {\n      this.chatInput.value = \"\";\n      this.chatInput.disabled = true;\n\n      try {\n        this.ui.addMessage(\"user\", message);\n        this.history.updateHistory({ type: \"user\", message });\n        await this.sendMessage(message);\n      } catch (error) {\n        console.error(\"Error sending message:\", error);\n        this.ui.addMessage(\n          \"assistant\",\n          \"Sorry, there was an error sending your message. Please try again.\"\n        );\n      } finally {\n        this.chatInput.disabled = false;\n        this.chatInput.focus();\n      }\n    }\n  }\n\n  async handleSpecialTrace(trace) {\n    console.log(\"Main chatbot handling special trace:\", trace);\n\n    switch (trace.type) {\n      case \"text\":\n        if (trace.payload?.message) {\n          this.history.updateHistory({\n            type: \"assistant\",\n            message: trace.payload.message,\n          });\n        }\n        break;\n\n      case \"choice\":\n        if (trace.payload?.buttons) {\n          this.history.updateHistory({\n            type: \"choice\",\n            buttons: trace.payload.buttons,\n          });\n        }\n        break;\n\n      case \"carousel\":\n        if (trace.payload) {\n          this.history.updateHistory({\n            type: \"carousel\",\n            data: trace.payload,\n          });\n        }\n        break;\n\n      case \"visual\":\n        if (trace.payload?.visualType === \"image\") {\n          this.history.updateHistory({\n            type: \"visual\",\n            data: trace.payload,\n          });\n        }\n        break;\n\n      case \"RedirectToProduct\":\n        const productHandle = trace.payload?.body?.productHandle;\n        if (productHandle) {\n          this.handleProductRedirect(productHandle);\n        }\n        break;\n    }\n  }\n\n  async jumpToMainMenu() {\n    console.log(\"MainChatbot jumpToMainMenu called\");\n    this.history.clearHistory();\n    this.messageContainer.innerHTML = \"\";\n    await this.sendMessage(\"start\");\n  }\n\n  handleProductRedirect(productHandle) {\n    if (productHandle) {\n      window.location.href = `/products/${productHandle}`;\n    }\n  }\n\n  displaySavedConversation() {\n    const history = this.history.getHistory();\n    history.forEach((entry) => {\n      switch (entry.type) {\n        case \"user\":\n        case \"assistant\":\n          this.ui.addMessage(entry.type, entry.message);\n          break;\n        case \"choice\":\n          this.ui.addButtons(entry.buttons);\n          break;\n        case \"carousel\":\n          this.ui.addCarousel(entry.data);\n          break;\n        case \"visual\":\n          this.ui.addVisualImage(entry.data);\n          break;\n      }\n    });\n  }\n}\n\nconsole.log(\"MainChatbot module loaded\");\n"],"names":["MainChatbot","ChatbotBase","element","config","HistoryHandler","error","form","event","button","buttonData","message","trace","_a","_b","_c","productHandle","_e","_d","entry"],"mappings":"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"}