import{C as a}from"./base-chatbot.grsVqGnb.js";import{M as n}from"./chatbot-main-ui.CqPclYCb.js";import"./vendor.DqvJXvYX.js";import"./streaming-markdown-parser.Bd3zPGns.js";import"./markdown-util.DadijVe3.js";import"./base-chatbot-ui.DCItXntY.js";function c(i){const e=Date.now().toString(36)+Math.random().toString(36).substr(2,9);return`${i}-${e}`}class h{constructor(e){this.container=e,this.historyKey="mainChatbotHistory",this.launchKey="chatHasLaunched",this.isLaunched=this.hasLaunched(),this.initialize()}initialize(){let e=localStorage.getItem("mainChatbotUserId");e||(e=c("mainChatbot"),localStorage.setItem("mainChatbotUserId",e)),this.core=new a({type:"main",endpoint:"https://chatbottings--development.gadget.app/voiceflowAPI/voiceflow-streaming",userID:e}),this.ui=new n({container:this.container,eventBus:this.core.eventBus,type:"main"}),this.setupEventListeners(),this.loadHistory()}setupEventListeners(){this.core.eventBus.on("userMessage",e=>{this.saveToHistory("user",e)}),this.core.eventBus.on("assistantMessageNonStreamed",({content:e,metadata:t})=>{this.saveToHistory("assistant",e,t)}),this.core.eventBus.on("messageReceived",({content:e,metadata:t})=>{this.ui.addMessage("assistant",e,t,!1)}),this.core.eventBus.on("assistantMessageFinalized",({content:e,metadata:t})=>{console.log("assistantMessageFinalized received with content:",e),this.saveToHistory("assistant",e,t)}),this.core.eventBus.on("error",({message:e})=>{this.ui.displayError(e)}),this.core.eventBus.on("choicePresented",({buttons:e})=>{this.saveToHistory("assistant","Choice presented",{type:"choice",buttons:e})}),this.core.eventBus.on("carouselPresented",({items:e})=>{this.saveToHistory("assistant","Carousel presented",{type:"carousel",carouselItems:e})}),this.core.eventBus.on("buttonClicked",e=>{const t=e.label||"Button clicked";this.saveToHistory("user",t)}),this.core.eventBus.on("mainMenu",()=>{const e="Main menu";this.saveToHistory("user",e),this.ui.addMessage("user",e,null,!1),this.core.sendAction({action:{type:"event",payload:{event:{name:"menu"}}}})}),this.core.eventBus.on("productRedirect",({productHandle:e})=>{this.handleProductRedirect(e)}),this.core.eventBus.on("clearHistory",()=>{this.clearHistory()}),this.core.eventBus.on("minimize",()=>{console.log("Minimize chatbot"),this.container.classList.toggle("minimized")})}hasLaunched(){return localStorage.getItem(this.launchKey)==="true"}setLaunched(){localStorage.setItem(this.launchKey,"true"),this.isLaunched=!0}async launch(){if(this.isLaunched){console.log("Chat already launched, skipping launch request");return}try{await this.core.sendLaunch(),this.setLaunched()}catch(e){console.error("Error launching chatbot:",e),this.ui.displayError("Failed to launch the chatbot. Please try again later.")}}saveToHistory(e,t,s=null){console.log("saveToHistory called with:",{sender:e,message:t,metadata:s});const r=JSON.parse(localStorage.getItem(this.historyKey))||[],o={sender:e,message:t,timestamp:Date.now(),isInteractive:!1};e==="assistant"&&s&&(s.type==="choice"?(o.isInteractive=!0,o.traceType="choice",o.traceData={buttons:s.buttons}):s.type==="carousel"&&(o.isInteractive=!0,o.traceType="carousel",o.traceData={cards:s.carouselItems})),r.push(o),localStorage.setItem(this.historyKey,JSON.stringify(r))}loadHistory(){const e=JSON.parse(localStorage.getItem(this.historyKey))||[];console.log("Loading history:",e),e.forEach((t,s)=>{if(console.log("Processing history entry:",t),t.isInteractive){console.log("Entry is interactive:",t),s===e.length-1&&(console.log("Restoring interactive element from history"),this.restoreInteractiveElement(t));return}t.message&&(console.log("Adding message from history:",t),this.ui.addMessage(t.sender,t.message,null,!0))})}handleProductRedirect(e){if(!e){console.error("Cannot redirect: Product handle is undefined or empty");return}const s=`https://www.sherpapower.co.uk/products/${encodeURIComponent(e)}`;console.log(`Redirecting to product page: ${s}`),window.location.href=s}restoreInteractiveElement(e){e.traceType==="choice"?this.ui.addButtons(e.traceData.buttons,!0):e.traceType==="carousel"&&this.ui.addCarousel(e.traceData.cards,!0)}clearHistory(){localStorage.removeItem(this.historyKey),localStorage.removeItem(this.launchKey),this.isLaunched=!1,this.ui.clearChat()}destroy(){this.core.destroy(),this.ui.destroy()}}window.MainChatbot=h;
//# sourceMappingURL=chatbot-main.B9aUU4me.js.map
