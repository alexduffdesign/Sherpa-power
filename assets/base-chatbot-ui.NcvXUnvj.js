import"./vendor.DqvJXvYX.js";import"./marked.esm.DtrQ3Nt4.js";class d{constructor(e){if(!e.container)throw new Error("ChatbotUI requires a container element");if(!e.eventBus)throw new Error("ChatbotUI requires an event bus");this.container=e.container,this.eventBus=e.eventBus,this.type=e.type,this.currentAssistantMessage=null,this.accumulatedContent="",this.setupUIElements(),this.setupEventListeners()}setupUIElements(){var n;const e=this.container.querySelectorAll(".message-container");this.messageContainer=e[0],console.log("Message container found:",!!this.messageContainer);const s=this.container.querySelectorAll(".chat-form");this.form=s[0],console.log("Chat form found:",!!this.form);const t=this.container.querySelectorAll(".chatbot-input");this.input=t[0],console.log("Chat input found:",!!this.input);const i=this.container.querySelectorAll(".chat-typing");if(this.typingIndicator=i[0],console.log("Typing indicator found:",!!this.typingIndicator),this.typingText=(n=this.typingIndicator)==null?void 0:n.querySelector(".typing-text"),console.log("Typing text found:",!!this.typingText),console.log("Container HTML:",this.container.innerHTML),!this.messageContainer||!this.form||!this.input){const a=[];throw this.messageContainer||a.push("message-container"),this.form||a.push("chat-form"),this.input||a.push("chatbot-input"),new Error(`Required UI elements not found: ${a.join(", ")}`)}}setupEventListeners(){this.form.addEventListener("submit",e=>{e.preventDefault();const s=this.input.value.trim();s&&(this.eventBus.emit("userMessage",s),this.input.value="")}),this.eventBus.on("messageReceived",({content:e,metadata:s,isStreamed:t})=>{console.log("UI received messageReceived event:",e,s,t),this.handleAssistantMessage(e,s,t)}),this.eventBus.on("partialMessage",({content:e,isStreamed:s})=>{this.handlePartialMessage(e,s)}),this.eventBus.on("finalMessage",({content:e,isStreamed:s})=>{this.handleFinalMessage(e,s)}),this.eventBus.on("typing",({isTyping:e})=>{e?this.showTypingIndicator():this.hideTypingIndicator()}),this.eventBus.on("error",({message:e})=>{this.displayError(e)}),this.eventBus.on("choicePresented",({buttons:e})=>{this.addButtons(e)}),this.eventBus.on("carouselPresented",({items:e})=>{this.addCarousel(e)}),this.eventBus.on("end",()=>{this.currentAssistantMessage=null,this.accumulatedContent=""})}handleAssistantMessage(e,s,t){const i=s&&s.fromHistory,n=!t&&!i,a=i?10:void 0,o=this.createMessage("assistant",e,s,n,a,t);this.messageContainer.appendChild(o),this.scrollToBottom()}handlePartialMessage(e,s){this.accumulatedContent+=e;const t=/([.!?;]\s)|(\n)/,i=this.accumulatedContent.match(t);if(i){const n=i.index+i[0].length,a=this.accumulatedContent.slice(0,n).trim(),o=this.accumulatedContent.slice(n).trim();this.currentAssistantMessage?this.currentAssistantMessage.appendContent(a):(this.currentAssistantMessage=this.createMessage("assistant",a,null,!s,void 0,s),this.messageContainer.appendChild(this.currentAssistantMessage)),this.accumulatedContent=o,this.scrollToBottom()}else this.currentAssistantMessage?this.currentAssistantMessage.appendContent(e):(this.currentAssistantMessage=this.createMessage("assistant",e,null,!s,void 0,s),this.messageContainer.appendChild(this.currentAssistantMessage)),this.scrollToBottom()}handleFinalMessage(e,s){if(this.currentAssistantMessage)this.currentAssistantMessage.appendContent(e),this.currentAssistantMessage=null,this.accumulatedContent="",this.scrollToBottom();else{const t=this.createMessage("assistant",e,null,!s,void 0,s);this.messageContainer.appendChild(t),this.scrollToBottom()}}createMessage(e,s,t=null,i=!0,n,a=!1){const o=document.createElement("message-component");return o.eventBus=this.eventBus,o.setAttribute("sender",e),o.setAttribute("content",s),t&&o.setAttribute("metadata",JSON.stringify(t)),i||o.setAttribute("data-animate","false"),n&&o.setAttribute("data-animation-speed",n.toString()),o}addMessage(e,s,t=null,i=!1,n=!1,a=void 0){if(console.log(`addMessage called with sender=${e}, content=${s}, metadata=`,t,`, fromHistory=${i}, isStreamed=${n}, animationSpeed=${a}`),e==="assistant"){const o=!n&&!i,l=n?void 0:i?10:a;if(n){const r=this.createMessage("assistant",s,t,!1,a,n);this.messageContainer.appendChild(r)}else{const r=this.createMessage("assistant",s,t,o,l,n);this.messageContainer.appendChild(r)}this.scrollToBottom()}else if(e==="user"){const o=!i,l=a||(i?10:void 0),r=this.createMessage(e,s,t,o,l,n);this.messageContainer.appendChild(r),this.scrollToBottom()}}handlePartialMessage(e,s){this.currentAssistantMessage||(this.currentAssistantMessage=this.createMessage("assistant","",null,!1,void 0,!0),this.messageContainer.appendChild(this.currentAssistantMessage)),this.currentAssistantMessage.appendContent(e),this.scrollToBottom()}handleFinalMessage(e,s){if(console.log("handleFinalMessage called",{fullContent:e,isStreamed:s}),this.currentAssistantMessage)this.currentAssistantMessage.finalizeContentAndAnimate(),this.currentAssistantMessage=null,this.accumulatedContent="";else{console.warn("handleFinalMessage called but currentAssistantMessage is null",{fullContent:e,isStreamed:s});const t=this.createMessage("assistant",e,null,!1,void 0,s);this.messageContainer.appendChild(t)}this.scrollToBottom()}addButtons(e,s=!1){if(!Array.isArray(e)){console.error("Invalid buttons data:",e);return}const t=document.createElement("div");t.className="button-group",e.forEach(i=>{const n=document.createElement("button-component");n.eventBus=this.eventBus,n.setAttribute("label",i.name),n.setAttribute("payload",JSON.stringify(i.request)),t.appendChild(n)}),this.messageContainer.appendChild(t),this.scrollToBottom()}addCarousel(e,s=!1){if(!Array.isArray(e)){console.error("Invalid carousel items:",e);return}const t=document.createElement("carousel-component");t.eventBus=this.eventBus,t.setAttribute("data-carousel",JSON.stringify({cards:e})),this.messageContainer.appendChild(t),this.scrollToBottom()}showTypingIndicator(){this.typingIndicator&&(this.typingIndicator.style.display="flex",this.scrollToBottom())}hideTypingIndicator(){this.typingIndicator&&(this.typingIndicator.style.display="none")}displayError(e){const s=document.createElement("div");s.classList.add("error-message"),s.textContent=e,this.messageContainer.appendChild(s),this.scrollToBottom()}removeInteractiveElements(){this.messageContainer.querySelectorAll("button-component, carousel-component, .button-group").forEach(s=>s.remove())}scrollToBottom(){this.messageContainer.scrollTop=this.messageContainer.scrollHeight}destroy(){this.abortController&&this.abortController.abort(),this.eventBus.removeAllListeners()}}export{d as C};
//# sourceMappingURL=base-chatbot-ui.NcvXUnvj.js.map
