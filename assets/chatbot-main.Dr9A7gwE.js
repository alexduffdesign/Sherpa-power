import{C as r,M as h,e as a,E as i}from"./chatbot-components.CwGjjfpr.js";import{g as c}from"./user-id-generator.DhYYxFTy.js";import"./vendor.DqvJXvYX.js";class u{constructor(t,e){this.core=t,this.ui=e,this.historyKey="mainChatbotHistory",this.launchKey="chatHasLaunched",this.isLaunched=this.hasLaunched(),this.setupEventListeners()}hasLaunched(){return localStorage.getItem(this.launchKey)==="true"}setLaunched(){localStorage.setItem(this.launchKey,"true"),this.isLaunched=!0}setupEventListeners(){a.on(i.MAIN_CHATBOT.MESSAGE_RECEIVED,t=>{this.ui.addMessage("assistant",t.content,t.metadata)}),a.on(i.MAIN_CHATBOT.CHOICE_PRESENTED,t=>{this.ui.addButtons(t.buttons)}),a.on(i.MAIN_CHATBOT.CAROUSEL_PRESENTED,t=>{this.ui.addCarousel(t.carouselItems)}),a.on(i.MAIN_CHATBOT.ERROR,t=>{this.ui.displayError(t.message)}),a.on(i.MAIN_CHATBOT.TYPING,t=>{t.isTyping?this.ui.showTypingIndicator():this.ui.hideTypingIndicator()}),document.addEventListener("chatbotLaunch",()=>{this.launch()}),this.ui.onUserMessage(t=>{this.sendMessage(t)}),this.ui.onButtonClick(t=>{this.sendAction(t)})}launch(){if(this.isLaunched){console.log("Chat already launched, skipping launch request");return}this.core.sendLaunch().then(()=>{console.log("Chatbot launched successfully."),this.setLaunched()}).catch(t=>{console.error("Error launching chatbot:",t),this.ui.displayError("Failed to launch the chatbot. Please try again later.")})}sendMessage(t){const e=this.sanitizeInput(t);this.ui.addMessage("user",e,{type:"message"}),this.saveToHistory("user",e,{type:"message"}),this.core.sendMessage(e).catch(s=>{console.error("Error sending message:",s),this.ui.displayError("Failed to send your message. Please try again.")})}sendAction(t){if(!t||typeof t!="object"){console.error("Invalid action payload:",t),this.ui.displayError("Invalid action triggered.");return}this.core.sendAction({action:t,config:{}}).then(()=>{console.log("Action sent successfully:",t),this.ui.addMessage("user",t.label||"Action executed.",{type:"action"}),this.saveToHistory("user",JSON.stringify(t),{type:"action"})}).catch(e=>{console.error("Error sending action:",e),this.ui.displayError("An error occurred while processing your request.")})}loadHistory(){(JSON.parse(localStorage.getItem(this.historyKey))||[]).forEach(e=>{if(e.sender==="user")this.ui.addMessage("user",e.message,e.metadata);else if(e.sender==="assistant"&&(this.ui.addMessage("assistant",e.message,e.metadata),e.metadata))switch(e.metadata.type){case"choice":this.ui.addButtons(e.metadata.buttons);break;case"carousel":this.ui.addCarousel(e.metadata.carouselItems);break}})}saveToHistory(t,e,s=null){const n=JSON.parse(localStorage.getItem(this.historyKey))||[];n.push({sender:t,message:e,metadata:s}),localStorage.setItem(this.historyKey,JSON.stringify(n))}sanitizeInput(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}}document.addEventListener("DOMContentLoaded",()=>{const o=document.getElementById("main-chatbot-ui");if(!o){console.error("Main Chatbot UI container not found");return}let t=localStorage.getItem("mainChatbotUserId");t||(t=c("mainChatbot"),localStorage.setItem("mainChatbotUserId",t));const e=new r({userID:t,endpoint:"https://chatbottings--development.gadget.app/voiceflowAPI/voiceflow-streaming",chatbotType:"main"}),s=new h(o);new u(e,s).loadHistory()});export{u as M};
//# sourceMappingURL=chatbot-main.Dr9A7gwE.js.map
