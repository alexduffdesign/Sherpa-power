{"version":3,"file":"chatbot-section-BrJiECSp.js","sources":["../frontend/entrypoints/chatbot-section.js"],"sourcesContent":["import { ChatbotCore } from \"./chatbot-core-file.js\";\n\nconsole.log(\"SectionChatbot module loading\");\n\nclass SectionChatbot extends HTMLElement {\n  constructor() {\n    super();\n    console.log(\"SectionChatbot constructor called\");\n    this.core = null;\n    this.eventListenersAttached = false;\n  }\n\n  connectedCallback() {\n    console.log(\"SectionChatbot connected to the DOM\");\n    this.initialize();\n  }\n\n  initialize() {\n    console.log(\"SectionChatbot initializing\");\n    const config = {\n      apiEndpoint: \"https://chatbottings--development.gadget.app/voiceflow\",\n      userIDPrefix: \"sectionChatBot\",\n    };\n    this.core = new ChatbotCore(config);\n\n    this.initializeElements();\n    this.setupEventListeners();\n\n    // Use document.querySelector for the applications grid\n    this.applicationsGrid = document.querySelector(\".applications-grid\");\n    if (!this.applicationsGrid) {\n      console.error(\"Applications grid not found during initialization\");\n    } else {\n      console.log(\"Applications grid found during initialization\");\n    }\n\n    this.loadSavedDevices();\n    this.initializeChat();\n  }\n\n  initializeElements() {\n    console.log(\"SectionChatbot initializeElements called\");\n    const messageContainer = this.querySelector(\"#messageContainer\");\n    const typingIndicator = this.querySelector(\".chat-typing\");\n    const applicationsGrid = document.querySelector(\".applications-grid\");\n\n    if (!messageContainer || !typingIndicator) {\n      console.error(\"Required DOM elements not found\");\n      return;\n    }\n\n    this.core.setDOMElements(messageContainer, typingIndicator, this);\n    this.applicationsGrid = applicationsGrid;\n    console.log(\"DOM elements set in ChatbotCore:\", this.core);\n  }\n\n  setupEventListeners() {\n    if (this.eventListenersAttached) return;\n\n    console.log(\"SectionChatbot setupEventListeners called\");\n    const form = this.querySelector(\"#chatForm\");\n    const input = this.querySelector(\"#userInput\");\n\n    if (!form || !input) {\n      console.error(\"Chat form or input not found\");\n      return;\n    }\n\n    form.addEventListener(\"submit\", async (e) => {\n      e.preventDefault();\n      const message = input.value.trim();\n      if (message) {\n        console.log(\"Form submitted with message:\", message);\n        input.value = \"\"; // Clear the input field immediately\n        await this.handleUserMessage(message);\n      }\n    });\n\n    this.addEventListener(\"click\", async (e) => {\n      if (e.target.matches(\".button-container button\")) {\n        const buttonData = JSON.parse(e.target.dataset.buttonData);\n        try {\n          const response = await this.core.handleButtonClick(buttonData);\n          await this.handleAgentResponse(response);\n        } catch (error) {\n          console.error(\"Error handling button click:\", error);\n        }\n      }\n    });\n\n    this.eventListenersAttached = true;\n  }\n\n  async handleUserMessage(message) {\n    this.core.addMessage(\"user\", message);\n\n    this.core.showTypingIndicator();\n    try {\n      const response = await this.core.sendMessage(message);\n      console.log(\"Response from sendMessage:\", response);\n      await this.handleAgentResponse(response);\n    } catch (error) {\n      console.error(\"Error in send message:\", error);\n    } finally {\n      this.core.hideTypingIndicator();\n      this.core.scrollToBottom();\n    }\n  }\n\n  async handleAgentResponse(response) {\n    console.log(\"Handling agent response:\", response);\n    for (const trace of response) {\n      if (trace.type === \"text\") {\n        this.core.addMessage(\"assistant\", trace.payload.message);\n      } else if (trace.type === \"choice\") {\n        this.core.addButtons(trace.payload.buttons);\n      } else if (trace.type === \"device_answer\") {\n        this.handleDeviceAnswer(trace.payload);\n      } else {\n        console.log(\"Unknown trace type:\", trace.type);\n      }\n    }\n    this.core.scrollToBottom();\n  }\n\n  handleDeviceAnswer(deviceAnswer) {\n    console.log(\"Handling device answer:\", deviceAnswer);\n    let devices = Array.isArray(deviceAnswer)\n      ? deviceAnswer\n      : deviceAnswer.devices;\n\n    if (!Array.isArray(devices)) {\n      console.error(\"Invalid devices data:\", devices);\n      return;\n    }\n\n    devices.forEach((device) => {\n      console.log(\"Processing device:\", device);\n      const { name, estimatedRuntime, powerConsumption } = device;\n      this.saveDeviceEstimate({ name, estimatedRuntime, powerConsumption });\n      const card = this.createDeviceCard(device);\n      this.insertCard(card);\n    });\n\n    try {\n      this.updateDevicesView();\n    } catch (error) {\n      console.error(\"Error in updateDevicesView:\", error);\n    }\n  }\n\n  createDeviceCard(device) {\n    const card = document.createElement(\"div\");\n    card.className = \"application-card chatbot-card\";\n    card.innerHTML = `\n      <div class=\"application-card__image\">\n        <svg width=\"50\" height=\"50\" viewBox=\"0 0 50 50\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n          <rect width=\"50\" height=\"50\" rx=\"25\" fill=\"#DB9BFB\"/>\n          <path d=\"M35.2941 18.5294H14.7059C13.7647 18.5294 13 19.2941 13 20.2353V32.7647C13 33.7059 13.7647 34.4706 14.7059 34.4706H35.2941C36.2353 34.4706 37 33.7059 37 32.7647V20.2353C37 19.2941 36.2353 18.5294 35.2941 18.5294ZM35.2941 32.7647H14.7059V20.2353H35.2941V32.7647ZM34.4412 15.5882L36.1471 13.8824C36.4412 13.5882 36.4412 13.1471 36.1471 12.8529C35.8529 12.5588 35.4118 12.5588 35.1176 12.8529L33.4118 14.5588C31.9412 13.5882 30.1765 13 28.2647 13H21.7353C19.8235 13 18.0588 13.5882 16.5882 14.5588L14.8824 12.8529C14.5882 12.5588 14.1471 12.5588 13.8529 12.8529C13.5588 13.1471 13.5588 13.5882 13.8529 13.8824L15.5588 15.5882C13.7941 17.3529 12.7059 19.7059 12.7059 22.2941V23.1471H37.2941V22.2941C37.2941 19.7059 36.2059 17.3529 34.4412 15.5882ZM20.8824 20.2353H18.3235V17.6765H20.8824V20.2353ZM31.6765 20.2353H29.1176V17.6765H31.6765V20.2353Z\" fill=\"white\"/>\n        </svg>\n      </div>\n      <div class=\"application-card__content\">\n        <div class=\"application-card__title\">${device.name}</div>\n        <div class=\"application-card__runtime\">\n          ${device.estimatedRuntime.value} ${device.estimatedRuntime.unit}\n        </div>\n      </div>\n    `;\n    return card;\n  }\n\n  insertCard(card) {\n    this.applicationsGrid = document.querySelector(\".applications-grid\");\n    if (!this.applicationsGrid) {\n      console.error(\"Applications grid not found when inserting card\");\n      return;\n    }\n\n    const firstChatbotCard = this.applicationsGrid.querySelector(\n      \".application-card.chatbot-card\"\n    );\n    if (firstChatbotCard) {\n      this.applicationsGrid.insertBefore(card, firstChatbotCard);\n    } else {\n      this.applicationsGrid.appendChild(card);\n    }\n  }\n\n  saveDeviceEstimate(device) {\n    const key = `${this.getAttribute(\"product-title\")}_devices`;\n    let devices = JSON.parse(localStorage.getItem(key) || \"[]\");\n\n    const existingIndex = devices.findIndex((d) => d.name === device.name);\n    if (existingIndex !== -1) {\n      devices.splice(existingIndex, 1);\n    }\n    devices.unshift(device);\n\n    localStorage.setItem(key, JSON.stringify(devices));\n  }\n\n  updateDevicesView() {\n    console.log(\"Updating devices view\");\n    // Always use document.querySelector here to ensure we're getting the latest reference\n    this.applicationsGrid = document.querySelector(\".applications-grid\");\n    if (!this.applicationsGrid) {\n      console.error(\"Applications grid not found\");\n      return;\n    }\n\n    console.log(\"Applications grid found:\", this.applicationsGrid);\n\n    const allCards = this.applicationsGrid.querySelectorAll(\n      \".application-card.chatbot-card\"\n    );\n    console.log(\"Number of cards found:\", allCards.length);\n\n    const viewMoreButton = document.querySelector(\".view-more-button\");\n    const devicesPerPage = 3;\n\n    if (allCards.length > devicesPerPage) {\n      if (viewMoreButton) {\n        viewMoreButton.style.display = \"block\";\n        console.log(\"View more button displayed\");\n      } else {\n        console.warn(\"View more button not found\");\n      }\n      allCards.forEach((card, index) => {\n        card.style.display = index < devicesPerPage ? \"flex\" : \"none\";\n      });\n    } else {\n      if (viewMoreButton) {\n        viewMoreButton.style.display = \"none\";\n        console.log(\"View more button hidden\");\n      } else {\n        console.warn(\"View more button not found\");\n      }\n    }\n  }\n\n  async initializeChat() {\n    console.log(\"Initializing chat\");\n    await this.sendLaunch();\n    console.log(\"Chat initialized\");\n  }\n\n  async sendLaunch() {\n    console.log(\"Sending section chatbot launch request\");\n\n    // Prepare the product details\n    const productTitle = this.getAttribute(\"product-title\");\n    const productCapacity = this.getAttribute(\"product-capacity\");\n    const productDetails = `Power Station: ${productTitle}, Capacity: ${productCapacity}`;\n\n    const interactPayload = {\n      userAction: {\n        type: \"launch\",\n        payload: {\n          startBlock: \"shopifySection\",\n          powerStationDetails: productDetails,\n        },\n      },\n    };\n\n    try {\n      const response = await this.core.sendLaunch(interactPayload);\n      await this.handleAgentResponse(response);\n    } catch (error) {\n      console.error(\"Error in section chatbot send launch:\", error);\n    }\n  }\n\n  loadSavedDevices() {\n    const key = `${this.getAttribute(\"product-title\")}_devices`;\n    const savedDevices = JSON.parse(localStorage.getItem(key) || \"[]\");\n    savedDevices.forEach((device) => {\n      const card = this.createDeviceCard(device);\n      this.insertCard(card);\n    });\n    this.updateDevicesView();\n  }\n}\n\ncustomElements.define(\"section-chatbot\", SectionChatbot);\n\nconsole.log(\"SectionChatbot module loaded\");\n"],"names":["SectionChatbot","config","ChatbotCore","messageContainer","typingIndicator","applicationsGrid","form","input","e","message","buttonData","response","error","trace","deviceAnswer","devices","device","name","estimatedRuntime","powerConsumption","card","firstChatbotCard","key","existingIndex","d","allCards","viewMoreButton","devicesPerPage","index","productTitle","productCapacity","interactPayload"],"mappings":"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"}