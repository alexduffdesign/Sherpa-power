import{C as r,M as h,e as s,E as i}from"./chatbot-components.DxN0xpqo.js";import{g as c}from"./user-id-generator.DhYYxFTy.js";import"./vendor.DqvJXvYX.js";class u{constructor(e,t){this.core=e,this.ui=t,this.historyKey="mainChatbotHistory",this.launchKey="chatHasLaunched",this.isLaunched=this.hasLaunched(),this.setupEventListeners()}hasLaunched(){return localStorage.getItem(this.launchKey)==="true"}setLaunched(){localStorage.setItem(this.launchKey,"true"),this.isLaunched=!0}setupEventListeners(){s.on(i.MAIN_CHATBOT.MESSAGE_RECEIVED,e=>{this.ui.addMessage("assistant",e.content,e.metadata),this.saveToHistory("assistant",e.content,e.metadata)}),s.on("userMessage",e=>{this.ui.addMessage("user",e),this.saveToHistory("user",e),this.core.sendMessage(e)}),s.on("buttonClicked",e=>{if(!e||!e.label){console.error("Invalid button data:",e);return}this.ui.addMessage("user",e.label),this.saveToHistory("user",e.label);const t={action:{type:e.type}};e.payload&&Object.keys(e.payload).length>0&&(t.action.payload=e.payload),this.core.sendAction(t)}),s.on(i.MAIN_CHATBOT.CHOICE_PRESENTED,e=>{this.ui.addButtons(e.buttons)}),s.on(i.MAIN_CHATBOT.CAROUSEL_PRESENTED,e=>{this.ui.addCarousel(e.carouselItems)}),s.on(i.MAIN_CHATBOT.ERROR,e=>{this.ui.displayError(e.message)}),s.on(i.MAIN_CHATBOT.TYPING,e=>{e.isTyping?this.ui.showTypingIndicator():this.ui.hideTypingIndicator()}),document.addEventListener("chatbotLaunch",()=>{this.launch()})}launch(){if(this.isLaunched){console.log("Chat already launched, skipping launch request");return}this.core.sendLaunch().then(()=>{console.log("Chatbot launched successfully."),this.setLaunched()}).catch(e=>{console.error("Error launching chatbot:",e),this.ui.displayError("Failed to launch the chatbot. Please try again later.")})}sendMessage(e){const t=this.sanitizeInput(e);this.ui.addMessage("user",t,{type:"message"}),this.saveToHistory("user",t,{type:"message"}),this.core.sendMessage(t).catch(a=>{console.error("Error sending message:",a),this.ui.displayError("Failed to send your message. Please try again.")})}sendAction(e){if(!e||typeof e!="object"){console.error("Invalid action payload:",e),this.ui.displayError("Invalid action triggered.");return}this.core.sendAction({action:e,config:{}}).then(()=>{console.log("Action sent successfully:",e),this.ui.addMessage("user",e.label||"Action executed.",{type:"action"}),this.saveToHistory("user",JSON.stringify(e),{type:"action"})}).catch(t=>{console.error("Error sending action:",t),this.ui.displayError("An error occurred while processing your request.")})}loadHistory(){(JSON.parse(localStorage.getItem(this.historyKey))||[]).forEach(t=>{if(t.sender==="user")this.ui.addMessage("user",t.message,t.metadata);else if(t.sender==="assistant"&&(this.ui.addMessage("assistant",t.message,t.metadata),t.metadata))switch(t.metadata.type){case"choice":this.ui.addButtons(t.metadata.buttons);break;case"carousel":this.ui.addCarousel(t.metadata.carouselItems);break}})}saveToHistory(e,t,a=null){const n=JSON.parse(localStorage.getItem(this.historyKey))||[];n.push({sender:e,message:t,metadata:a}),localStorage.setItem(this.historyKey,JSON.stringify(n))}sanitizeInput(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}document.addEventListener("DOMContentLoaded",()=>{const o=document.getElementById("main-chatbot-ui");if(!o){console.error("Main Chatbot UI container not found");return}let e=localStorage.getItem("mainChatbotUserId");e||(e=c("mainChatbot"),localStorage.setItem("mainChatbotUserId",e));const t=new r({userID:e,endpoint:"https://chatbottings--development.gadget.app/voiceflowAPI/voiceflow-streaming",chatbotType:"main"}),a=new h(o);new u(t,a).loadHistory()});export{u as M};
//# sourceMappingURL=chatbot-main.C3nHAWy1.js.map
